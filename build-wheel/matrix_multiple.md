---
title: matrix_multiple
created: 2023-06-18 16:37
aliases: []
tags:
  - dl 
  - gemm 
  - linear_algebra 
---

# 从线性映射到矩阵

许多机器学习任务，从构建映射的视角来看，都是将某一些输入的特征，通过人为构建的、或可学习的映射，来得到输出的，更“富有含义”的特征，或者与任务直接相关的特征（比如分类任务的类别概率）。

此外，重新规整看待一下矩阵乘法和实现一下矩阵乘法，会对卷积，RNN等算法也有更好更统一的理解。

既然要构造映射，一种很自然的想法，就是用简单的映射关系，去逐层构成复杂的映射关系。而最简单的映射，当然是线性映射。从定义上来看，说明好线性映射这个事，需要前置的说明很多概念，这里的描述会在严谨性和叙述的自然性间做一定折衷。推荐的阅读顺序也是，直接跳到线性映射的表述，在有需要的时候再折回来看基础定义。

1. 映射是什么
2. 线性空间是什么
3. 线性性和线性映射又是什么

## 映射

映射是指两个集合上(不妨记为$A, B$)的一种关系，是指$\forall a \in A$，对于这个$a$，这个“映射关系”都在集合$B$中，给出唯一对应的$b$，则称以上这种关系为映射，一个映射可以用字母简单做为代号记录，并写上它是什么集合之间的对应关系，比如以上描述的映射的一种记载方法就是$f: A \to B$。

## 线性空间

线性空间（也称向量空间）是指定义了加法和数乘的集合。这里的加法和数乘，也是抽象出来的，满足一些性质的运算（具体什么性质马上会提）。而向量空间和线性空间两个称谓，前一个称呼，可以看出来是这个定义是抽象自向量这个比较具体的对象，以及它满足的运算律；后一个称谓则重在关注说，一般我们会在这上面讨论“线性”这类东西。

一个能被称为线性空间的集合$V$，应当满足如下的性质：

1. 存在一种二元运算 $+: V \times V -> V$， 这个运算满足如下性质：
  - 交换律：$\forall a, b \in V, a + b = b + a$
  - 结合律：$\forall a, b, c \in V, (a + b) + c = a + (b + c)$
  - 对应此运算的零元的存在性：$\exists a \in V$, s.t. $\forall b \in V$, $a + b = b$。一般来说，此时不妨就将这个零元记为$0$，当然也可以有其他记号。
  - 逆元的存在性：$\forall a \in V$, $\exists b \in V$ s.t., $a + b$的结果为零元。一般来说，此时不妨将这个对应的逆元记为$-a$

2. 存在一种数乘运算 $\cdot : \mathbb{F} \times V -> V$，($\mathbb{F}$是数域，即其上定义了加法和乘法，对应的0和单位乘法元的代数结构)这个运算满足如下性质
  - 保数域的分配律： $\forall k, l \in \mathbb{F}, \forall a \in V$, $(k + l) a = ka + la$
  - 保数域的结合律：$\forall k, l \in \mathbb{F}, k(la) = (kl) a$。 注意，后者是先执行了数域$\mathbb{F}$上的乘法再执行了这个$V$上的数乘。
  - 乘法单位元对数乘的作用： $\mathbb{F}$上的乘法单位元$i$, $\forall a \in V$, $ia = a$。当然一般来说，数域上的乘法单位元，都会被记成$1$, 把$1$换上去重看以上定义也是可以的。
  - $V$上的分配律：$\forall k \in \mathbb{F}, \forall a, b \in V$, $k(a + b) = ka + kb$

满足以上条件的集合$V$就被成为线性空间。当然，可以看到，单独的一个集合$V$是不能满足的，要配套的有其上定义的加法和数乘运算，以及数乘的数所来自的数域，所以也可以把线性空间记为$(V, +, \cdot, \mathbb{F})$这样的四元组。

## 线性映射

### 线性映射的定义和刻画

若从线性空间$V_1$到线性空间$V_2$上的映射$f$，满足以下性质，则称它为线性映射。

1. $\forall a, b \in V_1, f(a + b) = f(a) + f(b)$
2. $\forall k \in \mathbb{F}, f(ka) = kf(a)$

只看定义的叙述是很平淡的，不妨再多做一点描述。

不妨看看额外加了这些限制以后，映射的性质变好成什么样了。对于这样的映射，输入是什么样的复杂的加法和数乘组成的$V_1$上的元素，我们都可以反复运用以上的性质，把加法和数乘，移动到外面，也即先求映射结果，再做$V_2$上的加法数乘。也即

$$ f\left(\sum_{i=1}^n k_i a_i \right) = \sum_{i=1}^n f(k_i a_i) = \sum_{i=1}^n k_i f(a_i)$$

然后不妨再考虑一件事，将以上公式反过来考虑。以上公式正着看，是将一个$V_1$空间上一堆向量用加法数乘组成的复杂输入进行拆分的公式。但反过来看，我们可以先将任意$V_1$上的单一输入，在$V_1$上先进行拆分，拆分为固定的简单的$V_1$上的量的加权和，然后求出每个分量的在$f$的像，在$V_2$上再组合，得到原始输入在$f$作用后的像。

接下来的讨论具体在有限维线性空间上。在有限的$n$维空间上，这种拆分的自然方案就是按基$e_1, e_2, \dots, e_n$进行拆分。假设待拆分的$V_1$上的元素为$a$, 即：

$$ a = \sum_{i = 1}^n k_i e_i $$

从而，$f(a) = f(\sum_{i = 1}^n k_i e_i) = \sum_{i = 1}^n k_i f(e_i)$。再进一步进行解读，看看线性映射这条件是如何约束$f$的。如果我们定义的是一个抽象无约束的$V_1$到$V_2$的映射$f$，要完整地刻画$f$，需要给出任意$a$在$f$作用后的像，才算完整刻画和定义了$f$；但有了线性映射条件后，对任意的$a$，就一定会有本段开头提出的展开方式，那么，可以看到这时，为了刻画$f$，我们只需要定义$f$对于$V_1$上的那组基的像$f(e_1), f(e_2), \dots, f(e_n)$，那么对于任意的输入$a$，就可以按照以上公式进行展开，利用基的像$f(e_1), f(e_2), \dots, f(e_n)$，组成最后的$a$的像$f(a)$。

### 线性映射的复合

再进一步，我们考虑线性映射的复合，比较自然地导出用矩阵表示线性映射，和用矩阵乘法反应线性映射复合规则的这一流程。先考虑两个映射的复合，这样会涉及三个线性空间$V_1, V_2, V_3$，对应的，我们考虑将两个映射记为$f_{1 \to 2}, f_{2 \to 3}$，那么我们考虑复合而成的映射$f_{1 \to 3} = f_{2 \to 3} \circ f_{1 \to 2}$。直觉上来说，复合而成的映射$f_{1 \to 3}$也是线性的，证明如下。

$$ \begin{aligned} \forall a, b \in V_1, & \forall a, b \in V_1, \forall k, l \in \mathbb{F}, \\ f_{1 \to 3}(ka + lb) &= f_{2 \to 3}( f_{1 \to 2}(ka + lb)) \\ &= f_{2 \to 3}( kf_{1 \to 2}(a) + l f_{1 \to 2}(b)) \\ &= k f_{2 \to 3}(f_{1 \to 2}(a)) + l f_{2 \to 3}(f_{1 \to 2}(b)) \\ &= kf_{1 \to 3}(a) + l f_{1 \to 3}(b) \end{aligned}$$

把以上过程，用语言再重新描述一遍就是，因为线性映射可以把输入的线性组合移动到输出中，而在映射复合的场景下，第一组的输出又是第二组的输入，从而可以再次移动线性组合，到最外层的映射上，达到最外层，也就证明了复合而成的映射是线性映射。

现在$f_{1 \to 3}$有两个看待它的视角，从两个映射复合而成的映射，和直接是$V_1 \to V_3$的线性映射。后面这个视角，帮助我们建立要求取的目标。具体来说如下，因为$f_{1 \to 3}$还是线性映射，为了表达它，利用上面的结论就是需要表示出$V_1$上的基$e_1, e_2, \dots, e_{n_1}$的像$f_{1 \to 3}(e_1), f_{1 \to 3}(e_2), \dots, f_{1 \to 3}(e_{n_1})$。而前一个视角指出$f_{1 \to 3} = f_{2 \to 3} \circ f_{1 \to 2}$，就告诉了我们如何展开。以$e_1$的像求取为例

$$ f_{1 \to 3}(e_1) = f_{2 \to 3}(f_{1 \to 2}(e_1)) $$

在这个展开式中，$f_{1 \to 2}(e_1)$是直接查表可得的，是为了表达$f_{1 \to 2}$时，就建立有的表。不妨将这个结果记为$a_1^{(2)}$，表示是基$e_1$通过变换打到$V_2$上的像。但变换过一次以后，求取结果就不是直接查表可得的了。这个$a_1^{(2)} \in V_2$，不保证是简单的$V_2$上的基，当然我们可以对这个$a_1^{(2)}$的做$V_2$上的基展开$a_1^{(2)} = \sum_{i = 1}^{n_2} k_i e_{i}^{(2)}$，然后利用$f_{2 \to 3}$是线性变换的性质，做展开$f_{2 \to 3}(a_1^{(2)}) = \sum_{i = 1}^{n_2} k_i f(e_{i}^{(2)})$。这样，做一个加权求和，就能表达出$e_1$在$f_{1 \to 3}$下的像$f_{1 \to 3}(e_1)$。

在这里，我们会发现，任何向量$a$在其所属的向量空间$V$下的基$e_1, e_2, \dots, e_n$进行展开后的各项系数$k_1, k_2, \dots, k_n$是重要的，它决定了加权求和中，每项的权重。所以我们不妨将$a = \sum_{i=1}^n k_i e_i$，用这样的形式进行表达。

$$a = [k_1, k_2, \dots, k_n]^\top $$

这里这个转置符号的妙处之后会看到，为的是做一个从上到下书写的列向量表达。只是从把基展开的权重系数写出来这个要求来看，横着写和竖着写并没有差别。在这样的符号约束下，再考虑“表达一个线性映射，就是表达它的各个基的像”这个描述。还是先以表达$e_1$的像$f(e_1)$为例，$f(e_1) \in V_2$，所以自然的表达，就是将它在$V_2$上按它上面的基做展开，并再次留下系数。其他基的表达也类似，然后我们将各个基的像列出来

$$[f(e_1), f(e_2), \dots, f(e_n)]$$

这样就决定了线性映射$f$，因为$f(e_i)$也是只留下了$V_2$上的基展开系数，并且以列向量的形式表达，以上列表是一个$m$行(像空间维度)，$n$列(原空间维度)的一个表。当然这个数表是$m \times n$的，不定长宽的但是是一个矩形的样子，所以将其称为矩阵(matrix)

$$ \begin{bmatrix} a_{1,1}, a_{1, 2}, \dots, a_{1, n} \\ a_{2, 1}, a_{2,2}, \dots, a_{2, n} \\ \vdots, \vdots, \ddots, \vdots \\ a_{m, 1}, a_{m, 2}, \dots, a_{m, n} \end{bmatrix} $$

这样，对于任意$V_1$上的向量，$v = [k_1, k_2, \dots, k_n]^\top$，要求$f(a)$，则是把这个以上这个矩阵的每一列，按照$k_1, k_2, \dots, k_n$的权重，加权求和。这是想象执行一个线性映射的过程，即把$V_1$上的$n$个基向量经过$f$得到的$V_2$上$m$维空间上的像，加权求和。

$$ f(v) = \sum_{i = 1}^n k_i \begin{bmatrix} a_{1, i} \\ a_{2, i} \\ \vdots \\ a_{m, i} \end{bmatrix} $$

总结一下以上的内容，我们想展现的是“矩阵用于表示线性映射，它作用在向量上等价于把矩阵的每一列的列向量加权求和”。当然了在具体的编程实现的过程中，我们还是要对这个加权求和，落到$V_2$也即$m$维空间上每个分量来进行操作。也就是说，每个通道分别执行如下计算

$$ f(v)_1 = \sum_{i = 1}^n k_i a_{1, i} $$
$$ f(v)_2 = \sum_{i = 1}^n k_i a_{2, i} $$
$$ \vdots $$
$$ f(v)_m = \sum_{i = 1}^n k_i a_{m, i} $$

这里，可以自然的看到，对于具体的每个通道的加权求和的过程，它们公用的一套权重$k_1, k_2, \dots, k_n$。从“求映射结果就是求矩阵中每列加权求和”的视角来看，这个权重复用是自然而然会出现的。在这里指出是因为“寻找复用”会在后续的矩阵乘法的优化中起到作用。

由此，我们再来看线性映射复合的过程。这里不妨约定，$V_1, V_2, V_3$的维度分别是$n, k, m$维，这样最终的，复合的$V_1 \to V_3$的线性映射会能表达成一个$m \times n$的矩阵，而中间$V_1 \to V_2, V_2 \to V_3$的映射分别能表达成$k \times n, m \times k$的矩阵。按照之前还没有表示成矩阵时，对于复合线性映射的分析，为了表示最终的$V_1 \to V_3$的线性映射，我们还是要求$V_1$上各个基的像在这个复合映射下的表示。还是具体以$e_1$的像求取为例

1. $V_1 \to V_2$: 结果是$f_{1 \to 2}(e_1) = f_{1 \to 2}([1, 0, \dots, 0]^\top)$，结果是表示$f_{1 \to 2}$的矩阵的第一列。不妨记为$[a_1, a_2, \dots, a_k]^\top$。
2. $V_2 \to V_3$: 将$f{2 \to 3}$的矩阵，按整列来紧凑表示 $[\boldsymbol{c}_1, \boldsymbol{c}_2, \dots, \boldsymbol{c}_k]$, 则  $f_{2 \to 3}([a_1, a_2, \dots, a_k]^\top) = \sum_{i = 1}^k a_i \boldsymbol{c}_i$。

这一组$m$维向量加权和的结果，就是$n$维度空间上的第一个单位基$[1, 0, \dots, 0]^\top$的像，应该将它写在表示$V_1 \to V_3$的线性映射的矩阵的第一列。那么重复的操作，第二列应该填写$e_2$在$f_{1 \to 2}$再$f_{2 \to 3}$两个映射后的结果... 注意到，不管取哪个$V_1$上的哪个基$e_i$, 第一步$f_{1 \to 2}$的结果都是容易得到的，直接取出$f_{1 \to 2}$的矩阵的第相应的第$i$列$\boldsymbol{c}_i$即可。所以真实的，要进行计算的过程是求$V_2 \to V_3$的映射$f_{2 \to 3}$作用在$\boldsymbol{c}_i$上的结果。所以，从这个视角来看，复合结果$f_{1 \to 3}$的矩阵映射的表达就一定会是

$$[f_{2 \to 3}(\boldsymbol{c}_1), f_{2 \to 3}(\boldsymbol{c}_2), \dots, f_{2 \to 3}(\boldsymbol{c}_k)]$$

也就是说，最终的复合映射等价的矩阵，是将$f_{2 \to 3}$作用在$f_{1 \to 2}$对应的矩阵的每一列上，对应地每一列的像，相应地排列。若记$f_{2 \to 3}$对应的矩阵为$A$，$f_{1 \to 2}$的矩阵为$B$，且$B$可以按列拆分为$B = [\boldsymbol{b}_1, \boldsymbol{b}_2, \dots, \boldsymbol{b}_n]$，且如果我们把线性映射作用在向量上写成，映射矩阵向量，中间无任何分隔符，比如$A$作用在$\boldsymbol{b}_1$上就是$A\boldsymbol{b}_1$，复合映射$f_{1 \to 3}$的矩阵$C$可以表达为

$$ C =  [A\boldsymbol{b}_1, A\boldsymbol{b}_2, \dots, A\boldsymbol{b}_n]$$

到这里，已经可以看出一些用列向量表示的好处以及将线性映射表示成

再代入之前所说的线性变换对应的矩阵的第$i$列，表示的就是原空间第$i$个基$e_i$在这个变换下结论(类似对$A$分列，得到)

# GEMM



